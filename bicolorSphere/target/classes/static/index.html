<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>双色球 - 趋势与预测</title>
  <style>
    :root{--bg:#141b33;--card:rgba(255,255,255,.10);--bd:rgba(255,255,255,.14);--t:#eef2ff;--m:rgba(238,242,255,.74);--red:#ff4d4f;--blue:#3a7bff;--acc:#4f7cff}
    html,body{height:100%;overflow-x:hidden}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--t)}
    .wrap{max-width:none;width:100%;margin:0 auto;padding:12px;box-sizing:border-box;min-height:100vh;display:flex;flex-direction:column}
    .top{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .title{font-size:20px;font-weight:700}
    .sub{color:var(--m);font-size:12px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:14px;margin-bottom:14px}
    .row{display:grid;grid-template-columns:1fr;gap:14px;flex:1 1 auto;min-height:0}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{background:var(--acc);color:#fff;border:0;border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn.secondary{background:rgba(255,255,255,.10)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    select,input{background:#fff;border:1px solid rgba(0,0,0,.18);color:#111;border-radius:10px;padding:10px 12px}
    select option{color:#111}
    .status{color:var(--m);font-size:12px}
    .divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .balls{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .ball{width:28px;height:28px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:12px}
    .ball.red{background:var(--red)}
    .ball.blue{background:var(--blue)}
    .pick{padding:10px;border:1px solid rgba(255,255,255,.10);border-radius:12px;background:rgba(255,255,255,.06);margin-bottom:10px}

    .trendCard{display:flex;flex-direction:column;min-height:0}
    .tableHeadWrap{overflow:hidden;flex:0 0 auto;background:rgba(20,28,56,.92);border:1px solid rgba(255,255,255,.10);border-radius:12px 12px 0 0;min-height:44px}
    .tableScrollTop{display:block;overflow:auto;flex:0 0 auto;margin-bottom:6px;border:1px solid rgba(255,255,255,.10);border-radius:10px;background:rgba(0,0,0,.12)}
    .tableScrollTopInner{height:1px}
    .tableBodyWrap{overflow:auto;background:rgba(0,0,0,.10);border:1px solid rgba(255,255,255,.10);border-top:0;border-radius:0 0 12px 12px;flex:1 1 auto;min-height:260px;scrollbar-gutter:stable both-edges;overflow-x:auto}
    table{border-collapse:collapse;width:max-content;min-width:100%;transform-origin:left top}
    th,td{border:1px solid rgba(255,255,255,.10);text-align:center;font-size:11px;line-height:20px;height:20px;padding:0;white-space:nowrap}
    thead th{background:rgba(20,28,56,.95)}
    th.group{font-weight:700;font-size:12px;color:rgba(232,236,255,.92)}
    th.sub{font-weight:600;color:rgba(232,236,255,.80)}
    td.left{font-size:12px;color:rgba(232,236,255,.92);background:rgba(0,0,0,.15)}
    td.week{width:40px}
    td.missR{color:rgba(255,200,200,.85)}
    td.missB{color:rgba(170,205,255,.90)}
    td.missG{color:rgba(220,220,220,.55)}
    .hit{width:16px;height:16px;border-radius:999px;margin:0 auto;display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px;font-weight:700}
    .hit.r{background:var(--red)}
    .hit.b{background:var(--blue)}

    .modalMask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:720px;max-width:calc(100vw - 28px);max-height:calc(100vh - 28px);background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 14px 40px rgba(0,0,0,.35)}
    .modalHd{background:var(--acc);color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between}
    .modalHd .t{font-weight:700}
    .modalBd{padding:12px;color:#111;max-height:calc(100vh - 150px);overflow:auto}
    .modalFt{padding:12px 14px;border-top:1px solid rgba(0,0,0,.08);display:flex;justify-content:flex-end;gap:10px}
    .btnGhost{background:#f1f1f1;color:#111;border:0;border-radius:10px;padding:10px 12px;cursor:pointer}
    .modalBd .status{color:rgba(0,0,0,.60)}
    .pick{background:#f6f7fb;border:1px solid rgba(0,0,0,.08)}
    .formGrid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:860px){.formGrid{grid-template-columns:1fr 1fr}}
    .modalBd select,.modalBd input{padding:8px 10px;border-radius:10px;font-size:12px}
    .modalBd .status{font-size:12px;white-space:nowrap}
    .modalForm{display:grid;grid-template-columns:84px 1fr 84px 1fr;gap:10px 12px;align-items:center}
    .modalForm .lbl{color:rgba(0,0,0,.65);font-size:12px;white-space:nowrap;justify-self:end}
    .modalForm input,.modalForm select{width:100%;box-sizing:border-box}
    .modalForm .span2{grid-column:2 / 5}
    .modalActions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:10px}
    .modalActions .status{color:rgba(0,0,0,.60)}
    .statsTable{width:100%;border-collapse:collapse;font-size:12px;color:#111}
    .statsTable th{background:#f4f6fb;color:#111;border-bottom:1px solid rgba(0,0,0,.10);padding:8px;text-align:left}
    .statsTable td{padding:8px;border-bottom:1px solid rgba(0,0,0,.06);background:#fff}
    .statsTable tr:nth-child(even) td{background:#fafbff}
    .statsTable .num{text-align:right}
    .statsSectionTitle{font-weight:700;margin:10px 0 6px 0;color:#111}
    .statsFilterForm{display:grid;grid-template-columns:84px 1fr 84px 1fr;gap:8px 12px;align-items:center}
    .statsFilterForm .lbl{color:rgba(0,0,0,.65);font-size:12px;white-space:nowrap;justify-self:end}
    .statsFilterForm input{width:100%;box-sizing:border-box}
    .statsFilterActions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
    @media(max-width:760px){
      .statsFilterForm{grid-template-columns:84px 1fr;}
      .statsFilterForm .lbl{justify-self:start}
    }
    @media(max-width:760px){
      .modalForm{grid-template-columns:84px 1fr;}
      .modalForm .span2{grid-column:2 / 3}
      .modalForm .lbl{justify-self:start}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">双色球趋势与预测</div>
        <div class="sub">趋势图 + 一键同步 + 多策略预测（仅供娱乐）</div>
      </div>
      <div class="status" id="healthPill">loading...</div>
    </div>

    <div class="card">
      <div class="toolbar">
        <button class="btn" id="syncBtn">同步数据</button>
        <span class="status" id="syncStatus"></span>
        <span style="flex:1 1 auto"></span>
        <button class="btn" id="statsOpenBtn">统计</button>
        <span class="status">最近N期</span>
        <select id="latestN">
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="200">200</option>
          <option value="300" selected>300</option>
          <option value="500">500</option>
          <option value="1000">1000</option>
          <option value="2000">2000</option>
          <option value="5000">5000</option>
        </select>
        <button class="btn secondary" id="refreshBtn">刷新</button>
        <button class="btn" id="predictOpenBtn">预测</button>
        <button class="btn secondary" id="predLibOpenBtn">预测库</button>
      </div>
    </div>

    <div class="row">
      <div class="card trendCard">
        <div class="toolbar" style="justify-content:space-between;">
          <div style="font-weight:700;">开奖号码趋势表</div>
          <div class="status">期号降序（最新在上）</div>
        </div>
        <div class="divider"></div>
        <div class="tableScrollTop" id="tableScrollTop"><div class="tableScrollTopInner" id="tableScrollTopInner"></div></div>
        <div class="tableHeadWrap" id="tableHeadWrap">
          <table id="trendHeadTable"></table>
        </div>
        <div class="tableBodyWrap" id="tableBodyWrap">
          <table id="trendBodyTable"></table>
        </div>
      </div>
    </div>

    <div class="modalMask" id="predictMask">
      <div class="modal" role="dialog" aria-modal="true">
        <div class="modalHd">
          <div class="t">预测</div>
          <button class="btnGhost" id="predictClose">关闭</button>
        </div>
        <div class="modalBd">
          <div class="modalForm">
            <div class="lbl">策略</div>
            <select id="strategy" class="span2" title="预测策略：不同算法生成候选号码，可配合下方约束条件过滤">
              <option value="frequency_top">热号优先</option>
              <option value="omission_top">遗漏优先</option>
              <option value="hybrid" selected>综合（热度+遗漏）</option>
              <option value="weighted_random">加权随机</option>
              <option value="zone_balanced">分区均衡（2:2:2）</option>
              <option value="markov">马尔科夫链</option>
              <option value="bayes">贝叶斯推理</option>
              <option value="ml">机器学习（轻量）</option>
            </select>

            <div class="lbl">注数</div>
            <input id="pickCount" value="5" title="生成的注数（1~20）" />
            <div class="lbl">重试</div>
            <input id="maxTry" placeholder="默认120" title="不满足约束时的最大重试次数（留空默认120）" />

            <div class="lbl">和值</div>
            <input id="minSum" placeholder="最小" title="和值下限（6个红球相加）" />
            <div class="lbl">和值</div>
            <input id="maxSum" placeholder="最大" title="和值上限（6个红球相加）" />

            <div class="lbl">跨度</div>
            <input id="minSpan" placeholder="最小" title="跨度下限（最大红球-最小红球）" />
            <div class="lbl">跨度</div>
            <input id="maxSpan" placeholder="最大" title="跨度上限（最大红球-最小红球）" />

            <div class="lbl">奇偶比</div>
            <input id="oddEvenRatio" placeholder="如 3:3" title="奇偶比（奇:偶），如 3:3、4:2（两数之和必须为6）" />

            <div class="lbl">区间比</div>
            <input id="zoneRatio" placeholder="如 2:2:2" title="区间比（1-11 / 12-22 / 23-33），如 2:2:2（三数之和必须为6）" />
            <div class="lbl">红胆</div>
            <input id="danReds" placeholder="如 1 8" title="红胆：必须包含的红球（空格或逗号分隔），如 1 8" />

            <div class="lbl">红杀</div>
            <input id="killReds" placeholder="如 3 16" title="红杀：必须排除的红球（空格或逗号分隔），如 3 16" />
            <div class="lbl">蓝胆</div>
            <input id="danBlues" placeholder="如 6 12" title="蓝胆：必须包含的蓝球（空格或逗号分隔），如 6 12" />

            <div class="lbl">蓝杀</div>
            <input id="killBlues" placeholder="如 1 16" title="蓝杀：必须排除的蓝球（空格或逗号分隔），如 1 16" />
          </div>

          <div class="modalActions">
            <button class="btn" id="predictBtn">生成预测</button>
            <button class="btn secondary" id="predictCopyBtn">复制第一注</button>
            <span class="status" id="predictStatus"></span>
          </div>
          <div class="divider" style="background:rgba(0,0,0,.08);"></div>
          <div id="predictResult"></div>
        </div>
        <div class="modalFt">
          <button class="btnGhost" id="predictAgain">再来一注</button>
          <button class="btn" id="predictOk">确定</button>
        </div>
      </div>
    </div>

    <div class="modalMask" id="statsMask">
      <div class="modal" role="dialog" aria-modal="true">
        <div class="modalHd">
          <div class="t">统计</div>
          <button class="btnGhost" id="statsClose">关闭</button>
        </div>
        <div class="modalBd">
          <div class="status" id="statsMeta"></div>
          <div style="margin-top:10px">
            <div class="statsFilterForm">
              <div class="lbl">和值</div>
              <input id="statsMinSum" placeholder="最小(可选)" />
              <div class="lbl">和值</div>
              <input id="statsMaxSum" placeholder="最大(可选)" />

              <div class="lbl">跨度</div>
              <input id="statsMinSpan" placeholder="最小(可选)" />
              <div class="lbl">跨度</div>
              <input id="statsMaxSpan" placeholder="最大(可选)" />

              <div class="lbl">区间比</div>
              <input id="statsZone" placeholder="如 2:2:2" />
              <div class="lbl">奇偶比</div>
              <input id="statsOE" placeholder="如 3:3" />
            </div>
            <div class="statsFilterActions">
              <button class="btn" id="statsApply">应用筛选</button>
              <button class="btn secondary" id="statsReset">重置</button>
              <span class="status" id="statsTip"></span>
            </div>
          </div>
          <div class="divider" style="background:rgba(0,0,0,.08);"></div>
          <div id="statsResult"></div>
        </div>
        <div class="modalFt">
          <button class="btn" id="statsOk">确定</button>
        </div>
      </div>
    </div>

    <div class="modalMask" id="predLibMask">
      <div class="modal" role="dialog" aria-modal="true">
        <div class="modalHd">
          <div class="t">预测库</div>
          <button class="btnGhost" id="predLibClose">关闭</button>
        </div>
        <div class="modalBd">
          <div class="statsFilterForm">
            <div class="lbl">期号</div>
            <input id="predLibDrawNo" placeholder="可选，如 2026002" />
            <div class="lbl">每页</div>
            <input id="predLibSize" value="50" />
          </div>
          <div class="statsFilterActions">
            <button class="btn" id="predLibQuery">查询</button>
            <button class="btn secondary" id="predLibPrev">上一页</button>
            <button class="btn secondary" id="predLibNext">下一页</button>
            <span class="status" id="predLibMeta"></span>
          </div>
          <div class="divider" style="background:rgba(0,0,0,.08);"></div>
          <div id="predLibResult"></div>
        </div>
        <div class="modalFt">
          <button class="btn" id="predLibOk">确定</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const api = (p) => p;

  const elLatestN = document.getElementById('latestN');
  const elSyncBtn = document.getElementById('syncBtn');
  const elSyncStatus = document.getElementById('syncStatus');
  const elRefreshBtn = document.getElementById('refreshBtn');
  const elHealth = document.getElementById('healthPill');
  const elPredictOpenBtn = document.getElementById('predictOpenBtn');
  const elStatsOpenBtn = document.getElementById('statsOpenBtn');
  const elPredLibOpenBtn = document.getElementById('predLibOpenBtn');

  const elStrategy = document.getElementById('strategy');
  const elPickCount = document.getElementById('pickCount');
  const elPredictBtn = document.getElementById('predictBtn');
  const elPredictCopyBtn = document.getElementById('predictCopyBtn');
  const elPredictStatus = document.getElementById('predictStatus');
  const elPredictResult = document.getElementById('predictResult');

  const elMinSum = document.getElementById('minSum');
  const elMaxSum = document.getElementById('maxSum');
  const elMinSpan = document.getElementById('minSpan');
  const elMaxSpan = document.getElementById('maxSpan');
  const elOddEvenRatio = document.getElementById('oddEvenRatio');
  const elZoneRatio = document.getElementById('zoneRatio');
  const elDanReds = document.getElementById('danReds');
  const elKillReds = document.getElementById('killReds');
  const elDanBlues = document.getElementById('danBlues');
  const elKillBlues = document.getElementById('killBlues');
  const elMaxTry = document.getElementById('maxTry');

  const elPredictMask = document.getElementById('predictMask');
  const elPredictClose = document.getElementById('predictClose');
  const elPredictAgain = document.getElementById('predictAgain');
  const elPredictOk = document.getElementById('predictOk');

  const elStatsMask = document.getElementById('statsMask');
  const elStatsClose = document.getElementById('statsClose');
  const elStatsOk = document.getElementById('statsOk');
  const elStatsMeta = document.getElementById('statsMeta');
  const elStatsResult = document.getElementById('statsResult');
  const elStatsMinSum = document.getElementById('statsMinSum');
  const elStatsMaxSum = document.getElementById('statsMaxSum');
  const elStatsMinSpan = document.getElementById('statsMinSpan');
  const elStatsMaxSpan = document.getElementById('statsMaxSpan');
  const elStatsZone = document.getElementById('statsZone');
  const elStatsOE = document.getElementById('statsOE');
  const elStatsApply = document.getElementById('statsApply');
  const elStatsReset = document.getElementById('statsReset');
  const elStatsTip = document.getElementById('statsTip');

  const elPredLibMask = document.getElementById('predLibMask');
  const elPredLibClose = document.getElementById('predLibClose');
  const elPredLibOk = document.getElementById('predLibOk');
  const elPredLibDrawNo = document.getElementById('predLibDrawNo');
  const elPredLibSize = document.getElementById('predLibSize');
  const elPredLibQuery = document.getElementById('predLibQuery');
  const elPredLibPrev = document.getElementById('predLibPrev');
  const elPredLibNext = document.getElementById('predLibNext');
  const elPredLibMeta = document.getElementById('predLibMeta');
  const elPredLibResult = document.getElementById('predLibResult');

  const elTableHeadWrap = document.getElementById('tableHeadWrap');
  const elTableBodyWrap = document.getElementById('tableBodyWrap');
  const elTableScrollTop = document.getElementById('tableScrollTop');
  const elTableScrollTopInner = document.getElementById('tableScrollTopInner');

  let lastTrend = null;
  let lastPredict = null;

  function pad2(n) {
    const s = String(n);
    return s.length === 1 ? '0' + s : s;
  }

  function setHealth(ok) {
    elHealth.innerText = ok ? 'API: OK' : 'API: FAIL';
  }

  async function checkHealth() {
    try {
      const res = await fetch(api('/api/health'));
      const data = await res.json();
      setHealth(!!data.ok);
    } catch (e) {
      setHealth(false);
    }
  }

  function weekdayFromDateStr(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return '';
    const wd = d.getDay();
    return wd === 0 ? '日' : (wd === 1 ? '一' : (wd === 2 ? '二' : (wd === 3 ? '三' : (wd === 4 ? '四' : (wd === 5 ? '五' : '六')))));
  }

  function statsForRow(reds) {
    const r = (reds || []).slice().sort((a,b)=>a-b);
    if (r.length !== 6) return {sum:'', span:'', zone:'', oe:''};
    let sum = 0;
    let odd = 0;
    let z1 = 0, z2 = 0, z3 = 0;
    for (let i = 0; i < 6; i++) {
      const n = r[i];
      sum += n;
      if (n % 2 === 1) odd++;
      if (n <= 11) z1++;
      else if (n <= 22) z2++;
      else z3++;
    }
    const span = r[5] - r[0];
    return { sum: String(sum), span: String(span), zone: `${z1}:${z2}:${z3}`, oe: `${odd}:${6-odd}` };
  }

  function buildColgroup() {
    const colgroup = document.createElement('colgroup');
    // 2个左侧列 + 33红球 + 16蓝球 + 4统计列
    const widths = [];
    widths.push(78);
    widths.push(42);
    for (let i = 0; i < 33; i++) widths.push(18);
    for (let i = 0; i < 16; i++) widths.push(18);
    widths.push(44);
    widths.push(44);
    widths.push(54);
    widths.push(54);
    colgroup.innerHTML = widths.map(w => `<col style="width:${w}px">`).join('');
    return colgroup;
  }

  function fitTrendTable() {
    try {
      const headTable = document.getElementById('trendHeadTable');
      const bodyTable = document.getElementById('trendBodyTable');
      if (!headTable || !bodyTable) return;
      headTable.style.transform = '';
      bodyTable.style.transform = '';
      headTable.style.width = '';
      bodyTable.style.width = '';
      bodyTable.style.marginBottom = '';

      syncTopScroller();
    } catch (e) {
    }
  }

  function buildHeader() {
    const thead = document.createElement('thead');

    const r1 = document.createElement('tr');
    r1.innerHTML = `
      <th class="group" rowspan="2">期号</th>
      <th class="group" rowspan="2">星期</th>
      <th class="group" colspan="11">一区</th>
      <th class="group" colspan="11">二区</th>
      <th class="group" colspan="11">三区</th>
      <th class="group" colspan="16">蓝球</th>
      <th class="group" rowspan="2">和值</th>
      <th class="group" rowspan="2">跨度</th>
      <th class="group" rowspan="2">区间比</th>
      <th class="group" rowspan="2">奇偶比</th>
    `;

    const r2 = document.createElement('tr');
    let ths = '';
    for (let i = 1; i <= 33; i++) ths += `<th class="sub">${pad2(i)}</th>`;
    for (let i = 1; i <= 16; i++) ths += `<th class="sub">${pad2(i)}</th>`;
    r2.innerHTML = ths;

    thead.appendChild(r1);
    thead.appendChild(r2);
    return thead;
  }

  function buildTable(trend) {
    const headTable = document.getElementById('trendHeadTable');
    const bodyTable = document.getElementById('trendBodyTable');
    const drawNos0 = trend.drawNos || [];
    const dates0 = trend.drawDates || [];
    const reds0 = trend.reds || [];
    const blues0 = trend.blues || [];

    // 强制按期号降序排序（不依赖后端顺序）
    const rows = [];
    for (let i = 0; i < drawNos0.length; i++) {
      rows.push({
        drawNo: drawNos0[i],
        drawDate: dates0[i],
        reds: reds0[i] || [],
        blue: blues0[i]
      });
    }
    rows.sort((a, b) => {
      const na = parseInt(String(a.drawNo || '0'), 10);
      const nb = parseInt(String(b.drawNo || '0'), 10);
      if (!isNaN(na) && !isNaN(nb) && na !== nb) return nb - na;
      return String(b.drawNo || '').localeCompare(String(a.drawNo || ''));
    });

    const missRed = new Array(34);
    const missBlue = new Array(17);
    for (let i = 0; i < missRed.length; i++) missRed[i] = 0;
    for (let i = 0; i < missBlue.length; i++) missBlue[i] = 0;

    const tbody = document.createElement('tbody');

    for (let row = 0; row < rows.length; row++) {
      const tr = document.createElement('tr');

      const r = rows[row];

      const tdNo = document.createElement('td');
      tdNo.className = 'left';
      tdNo.innerText = String(r.drawNo || '');
      tr.appendChild(tdNo);

      const tdW = document.createElement('td');
      tdW.className = 'left week';
      tdW.innerText = weekdayFromDateStr(r.drawDate);
      tr.appendChild(tdW);

      const redSet = new Set(r.reds || []);
      for (let n = 1; n <= 33; n++) {
        const td = document.createElement('td');
        if (redSet.has(n)) {
          missRed[n] = 0;
          td.innerHTML = `<div class="hit r">${pad2(n)}</div>`;
        } else {
          missRed[n] += 1;
          td.innerText = String(missRed[n]);
          td.className = (n <= 11) ? 'missR' : (n <= 22 ? 'missB' : 'missG');
        }
        tr.appendChild(td);
      }

      const blueHit = r.blue;
      for (let n = 1; n <= 16; n++) {
        const td = document.createElement('td');
        if (blueHit === n) {
          missBlue[n] = 0;
          td.innerHTML = `<div class="hit b">${pad2(n)}</div>`;
        } else {
          missBlue[n] += 1;
          td.innerText = String(missBlue[n]);
          td.className = 'missB';
        }
        tr.appendChild(td);
      }

      const st = statsForRow(r.reds);
      const t1 = document.createElement('td'); t1.innerText = st.sum; tr.appendChild(t1);
      const t2 = document.createElement('td'); t2.innerText = st.span; tr.appendChild(t2);
      const t3 = document.createElement('td'); t3.innerText = st.zone; tr.appendChild(t3);
      const t4 = document.createElement('td'); t4.innerText = st.oe; tr.appendChild(t4);

      tbody.appendChild(tr);
    }

    // Header table
    headTable.innerHTML = '';
    headTable.appendChild(buildColgroup());
    headTable.appendChild(buildHeader());

    // Body table (no thead)
    bodyTable.innerHTML = '';
    bodyTable.appendChild(buildColgroup());
    bodyTable.appendChild(tbody);

    requestAnimationFrame(() => {
      fitTrendTable();
      requestAnimationFrame(fitTrendTable);
    });
  }

  function syncTopScroller() {
    try {
      const headTable = document.getElementById('trendHeadTable');
      const w = elTableBodyWrap && elTableBodyWrap.scrollWidth ? elTableBodyWrap.scrollWidth : 0;
      elTableScrollTopInner.style.width = w ? (w + 'px') : '0px';
      elTableScrollTop.scrollLeft = elTableBodyWrap.scrollLeft;
      if (headTable && elTableBodyWrap) headTable.style.marginLeft = (-elTableBodyWrap.scrollLeft) + 'px';
    } catch (e) {
    }
  }

  if (elTableBodyWrap) {
    elTableBodyWrap.addEventListener('scroll', () => {
      syncTopScroller();
    });
  }
  if (elTableScrollTop) {
    elTableScrollTop.addEventListener('scroll', () => {
      if (!elTableBodyWrap) return;
      elTableBodyWrap.scrollLeft = elTableScrollTop.scrollLeft;
      try {
        const headTable = document.getElementById('trendHeadTable');
        if (headTable) headTable.style.marginLeft = (-elTableScrollTop.scrollLeft) + 'px';
      } catch (e) {
      }
    });
  }

  async function loadTrend() {
    const n = parseInt(elLatestN.value, 10) || 300;
    elSyncStatus.innerText = '加载中...';
    const res = await fetch(api(`/api/trend?latestN=${encodeURIComponent(n)}`));
    const data = await res.json();
    lastTrend = data;
    buildTable(data);
    elSyncStatus.innerText = `已加载 ${data.latestN} 期`;
  }

  function renderPicks(picks) {
    if (!picks || !picks.length) {
      elPredictResult.innerHTML = '<div class="status">暂无预测结果</div>';
      return;
    }
    let html = '';
    for (let i = 0; i < picks.length; i++) {
      const p = picks[i];
      const reds = (p.red || []).slice().sort((a,b)=>a-b);
      html += '<div class="pick">';
      html += `<div class="status">第 ${i+1} 注</div>`;
      html += '<div style="display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap;margin-top:8px;">';
      html += '<div class="balls" style="margin:0;">';
      for (let j = 0; j < reds.length; j++) html += `<span class="ball red">${pad2(reds[j])}</span>`;
      html += `<span class="ball blue">${pad2(p.blue)}</span>`;
      html += '</div>';
      html += '<div style="display:flex;gap:10px;align-items:center;justify-content:flex-end;flex:0 0 auto;">';
      html += `<button class="btn secondary" data-act="analyze" data-idx="${i}">分析</button>`;
      html += `<button class="btn" data-act="save" data-idx="${i}">加入预测库</button>`;
      html += '</div>';
      html += '</div>';
      html += '<div class="status" data-pick-status="' + i + '" style="margin-top:6px"></div>';
      html += '</div>';
    }
    elPredictResult.innerHTML = html;
  }

  function nextDrawNo(drawNo) {
    const t = drawNo == null ? '' : String(drawNo).trim();
    if (!t) return '';
    if (!/^\d{5,}$/.test(t)) return '';
    const year = t.substring(0, 4);
    const seqStr = t.substring(4);
    const seq = parseInt(seqStr, 10);
    if (isNaN(seq)) return '';
    const seqLen = seqStr.length;
    let ny = parseInt(year, 10);
    let ns = seq + 1;
    if (!isNaN(ny) && ns >= Math.pow(10, seqLen)) {
      ny += 1;
      ns = 1;
    }
    const nsStr = String(ns).padStart(seqLen, '0');
    return (isNaN(ny) ? year : String(ny)) + nsStr;
  }

  function latestDrawNoFromTrend() {
    const arr = lastTrend && lastTrend.drawNos ? lastTrend.drawNos : [];
    if (!arr || !arr.length) return '';
    // backend may return asc; front table sorts independently, so pick max draw_no safely
    let best = '';
    let bestN = -1;
    for (let i = 0; i < arr.length; i++) {
      const s = String(arr[i] || '').trim();
      const n = parseInt(s, 10);
      if (!isNaN(n) && n > bestN) {
        bestN = n;
        best = s;
      }
    }
    return best || String(arr[arr.length - 1] || '').trim();
  }

  function pickRedsText(p) {
    const reds = (p && p.red) ? p.red.slice().sort((a,b)=>a-b) : [];
    return reds.map(pad2).join(' ');
  }

  async function savePickToDb(p) {
    const latest = latestDrawNoFromTrend();
    const drawNo = nextDrawNo(latest);
    if (!drawNo) {
      elPredictStatus.innerText = '请先加载趋势数据，才能自动计算下一期号';
      return;
    }
    const redsText = pickRedsText(p);
    const blue = p && p.blue != null ? parseInt(String(p.blue), 10) : NaN;
    if (!redsText || isNaN(blue)) {
      elPredictStatus.innerText = '预测号码异常，无法入库';
      return;
    }
    const body = `drawNo=${encodeURIComponent(drawNo)}&reds=${encodeURIComponent(redsText)}&blue=${encodeURIComponent(blue)}`;
    const res = await fetch(api('/api/predictions'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body
    });
    return await res.json();
  }

  function findPickStatusEl(i) {
    return elPredictResult ? elPredictResult.querySelector(`[data-pick-status="${i}"]`) : null;
  }

  elPredictResult.addEventListener('click', async (e) => {
    const btn = e && e.target ? e.target.closest('button') : null;
    if (!btn) return;
    const act = btn.getAttribute('data-act');
    const idxStr = btn.getAttribute('data-idx');
    const idx = idxStr == null ? -1 : parseInt(idxStr, 10);
    const picks = (lastPredict && lastPredict.picks) ? lastPredict.picks : [];
    if (!act || isNaN(idx) || idx < 0 || idx >= picks.length) return;

    const p = picks[idx];
    const stEl = findPickStatusEl(idx);

    if (act === 'analyze') {
      const reds = (p.red || []).slice().sort((a,b)=>a-b);
      const st = statsForRow(reds);
      const text = `和值=${st.sum}  跨度=${st.span}  区间比=${st.zone}  奇偶比=${st.oe}`;
      if (stEl) stEl.innerText = text;
      return;
    }

    if (act === 'save') {
      if (stEl) stEl.innerText = '入库中...';
      btn.disabled = true;
      try {
        const data = await savePickToDb(p);
        const inserted = data && data.inserted != null ? data.inserted : 0;
        if (stEl) stEl.innerText = inserted ? '已加入预测库（新增）' : '已加入预测库（已存在）';
      } catch (err) {
        if (stEl) stEl.innerText = '入库失败，请稍后重试';
      } finally {
        btn.disabled = false;
      }
    }
  });

  async function predict() {
    const n = parseInt(elLatestN.value, 10) || 300;
    const strategy = String(elStrategy.value || 'hybrid');
    const count = Math.max(1, Math.min(20, parseInt(String(elPickCount.value || '5'), 10) || 5));
    elPickCount.value = String(count);

    const q = [];
    q.push(`latestN=${encodeURIComponent(n)}`);
    q.push(`strategy=${encodeURIComponent(strategy)}`);
    q.push(`count=${encodeURIComponent(count)}`);

    const addInt = (key, el) => {
      const raw = el && el.value != null ? String(el.value).trim() : '';
      if (!raw) return;
      const v = parseInt(raw, 10);
      if (!isNaN(v)) q.push(`${encodeURIComponent(key)}=${encodeURIComponent(v)}`);
    };
    const addStr = (key, el) => {
      const raw = el && el.value != null ? String(el.value).trim() : '';
      if (!raw) return;
      q.push(`${encodeURIComponent(key)}=${encodeURIComponent(raw)}`);
    };
    addInt('minSum', elMinSum);
    addInt('maxSum', elMaxSum);
    addInt('minSpan', elMinSpan);
    addInt('maxSpan', elMaxSpan);

    const oe = parseRatio2(elOddEvenRatio && elOddEvenRatio.value != null ? String(elOddEvenRatio.value) : '');
    if (elOddEvenRatio && String(elOddEvenRatio.value || '').trim() && oe == null) {
      elPredictStatus.innerText = '奇偶比格式应为 a:b 且和为6，例如 3:3';
      return;
    }
    if (oe != null) {
      const oddCnt = parseInt(oe.split(':')[0], 10);
      if (!isNaN(oddCnt)) {
        q.push(`minOdd=${encodeURIComponent(oddCnt)}`);
        q.push(`maxOdd=${encodeURIComponent(oddCnt)}`);
      }
    }

    addStr('zoneRatio', elZoneRatio);
    addStr('danReds', elDanReds);
    addStr('killReds', elKillReds);
    addStr('danBlues', elDanBlues);
    addStr('killBlues', elKillBlues);
    addInt('maxTry', elMaxTry);

    elPredictStatus.innerText = '生成中...';
    elPredictBtn.disabled = true;
    try {
      const res = await fetch(api(`/api/predict?${q.join('&')}`));
      const data = await res.json();
      lastPredict = data;
      renderPicks(data.picks || []);
      elPredictStatus.innerText = '';
    } finally {
      elPredictBtn.disabled = false;
    }
  }

  function openPredict() {
    elPredictMask.style.display = 'flex';
    // Do not show picks until user clicks "生成预测"
    lastPredict = null;
    elPredictStatus.innerText = '';
    elPredictResult.innerHTML = '<div class="status">点击“生成预测”后显示结果</div>';
  }
  function closePredict() {
    elPredictMask.style.display = 'none';
  }

  function openStats() {
    elStatsMask.style.display = 'flex';
  }
  function closeStats() {
    elStatsMask.style.display = 'none';
  }

  function openPredLib() {
    elPredLibMask.style.display = 'flex';
  }
  function closePredLib() {
    elPredLibMask.style.display = 'none';
  }

  let predLibPage = 0;
  async function loadPredLib(pageDelta) {
    predLibPage = Math.max(0, predLibPage + (pageDelta || 0));
    const drawNo = elPredLibDrawNo ? String(elPredLibDrawNo.value || '').trim() : '';
    const size = Math.max(1, Math.min(200, parseInt(String(elPredLibSize.value || '50'), 10) || 50));
    elPredLibSize.value = String(size);

    elPredLibMeta.innerText = '加载中...';
    const url = `/api/predictions/search?page=${encodeURIComponent(predLibPage)}&size=${encodeURIComponent(size)}` + (drawNo ? `&drawNo=${encodeURIComponent(drawNo)}` : '');
    const res = await fetch(api(url));
    const data = await res.json();

    const total = data && data.total != null ? data.total : 0;
    const p = data && data.page != null ? data.page : predLibPage;
    const rows = data && data.rows ? data.rows : [];
    elPredLibMeta.innerText = `共 ${total} 条，第 ${p + 1} 页`;

    let html = '';
    html += '<table class="statsTable">';
    html += '<thead><tr>';
    html += '<th>期号</th>';
    html += '<th>预测红</th>';
    html += '<th class="num">蓝</th>';
    html += '<th>真实红</th>';
    html += '<th class="num">蓝</th>';
    html += '<th class="num">命中率</th>';
    html += '<th class="num">误差率</th>';
    html += '</tr></thead><tbody>';
    for (let i = 0; i < rows.length; i++) {
      const r = rows[i] || {};
      const hr = r.hit_rate == null ? '' : String(r.hit_rate);
      const er = r.error_rate == null ? '' : String(r.error_rate);
      html += '<tr>';
      html += `<td>${r.draw_no || ''}</td>`;
      html += `<td>${r.predict_reds || ''}</td>`;
      html += `<td class="num">${r.predict_blue == null ? '' : r.predict_blue}</td>`;
      html += `<td>${r.actual_reds || ''}</td>`;
      html += `<td class="num">${r.actual_blue == null ? '' : r.actual_blue}</td>`;
      html += `<td class="num">${hr}</td>`;
      html += `<td class="num">${er}</td>`;
      html += '</tr>';
    }
    html += '</tbody></table>';
    elPredLibResult.innerHTML = html;
  }

  function sortEntriesDesc(obj) {
    const entries = Object.keys(obj || {}).map(k => ({ key: k, count: obj[k] }));
    entries.sort((a, b) => (b.count - a.count));
    return entries;
  }

  function parseIntOrNull(s) {
    const t = s == null ? '' : String(s).trim();
    if (!t) return null;
    const v = parseInt(t, 10);
    return isNaN(v) ? null : v;
  }

  function parseRatio3(s) {
    const t = s == null ? '' : String(s).trim();
    if (!t) return null;
    const parts = t.split(/[:：]/).map(x => x.trim()).filter(Boolean);
    if (parts.length !== 3) return null;
    const a = parseInt(parts[0], 10);
    const b = parseInt(parts[1], 10);
    const c = parseInt(parts[2], 10);
    if ([a,b,c].some(x => isNaN(x))) return null;
    if (a + b + c !== 6) return null;
    return `${a}:${b}:${c}`;
  }

  function parseRatio2(s) {
    const t = s == null ? '' : String(s).trim();
    if (!t) return null;
    const parts = t.split(/[:：]/).map(x => x.trim()).filter(Boolean);
    if (parts.length !== 2) return null;
    const a = parseInt(parts[0], 10);
    const b = parseInt(parts[1], 10);
    if ([a,b].some(x => isNaN(x))) return null;
    if (a + b !== 6) return null;
    return `${a}:${b}`;
  }

  function renderFreqTable(title, entries, topN, filterType) {
    const list = (entries || []).slice(0, topN);
    if (!list.length) return '';
    let html = '';
    html += `<div class="statsSectionTitle">${title}</div>`;
    html += '<table class="statsTable">';
    html += '<thead><tr>';
    html += '<th>项</th>';
    html += '<th class="num">次数</th>';
    html += '<th class="num">占比</th>';
    html += '</tr></thead><tbody>';
    const total = entries.reduce((s, x) => s + (x.count || 0), 0) || 1;
    for (let i = 0; i < list.length; i++) {
      const it = list[i];
      const pct = ((it.count || 0) * 100 / total).toFixed(1) + '%';
      html += filterType ? `<tr data-ft="${filterType}" data-fv="${String(it.key)}">` : '<tr>';
      html += `<td>${it.key}</td>`;
      html += `<td class="num">${it.count}</td>`;
      html += `<td class="num">${pct}</td>`;
      html += '</tr>';
    }
    html += '</tbody></table>';
    return html;
  }

  function applyStatsQuickFilter(ft, fv) {
    if (!ft) return;
    const v = fv == null ? '' : String(fv);
    if (ft === 'sum') {
      elStatsMinSum.value = v;
      elStatsMaxSum.value = v;
    } else if (ft === 'span') {
      elStatsMinSpan.value = v;
      elStatsMaxSpan.value = v;
    } else if (ft === 'zone') {
      elStatsZone.value = v;
    } else if (ft === 'oe') {
      elStatsOE.value = v;
    }
    renderStats();
  }

  function computeStatsFromTrend(trend, filter) {
    const drawNos = (trend && trend.drawNos) ? trend.drawNos : [];
    const redsArr = (trend && trend.reds) ? trend.reds : [];

    const sumFreq = {};
    const spanFreq = {};
    const zoneFreq = {};
    const oeFreq = {};

    let hit = 0;
    for (let i = 0; i < redsArr.length; i++) {
      const reds = (redsArr[i] || []).slice().sort((a,b)=>a-b);
      if (reds.length !== 6) continue;
      const st = statsForRow(reds);

      let ok = true;
      if (filter) {
        const sumV = st.sum ? parseInt(st.sum, 10) : null;
        const spanV = st.span ? parseInt(st.span, 10) : null;
        if (filter.minSum != null && sumV != null && sumV < filter.minSum) ok = false;
        if (filter.maxSum != null && sumV != null && sumV > filter.maxSum) ok = false;
        if (filter.minSpan != null && spanV != null && spanV < filter.minSpan) ok = false;
        if (filter.maxSpan != null && spanV != null && spanV > filter.maxSpan) ok = false;
        if (filter.zone != null && st.zone !== filter.zone) ok = false;
        if (filter.oe != null && st.oe !== filter.oe) ok = false;
      }
      if (!ok) continue;
      hit += 1;

      if (st.sum) sumFreq[st.sum] = (sumFreq[st.sum] || 0) + 1;
      if (st.span) spanFreq[st.span] = (spanFreq[st.span] || 0) + 1;
      if (st.zone) zoneFreq[st.zone] = (zoneFreq[st.zone] || 0) + 1;
      if (st.oe) oeFreq[st.oe] = (oeFreq[st.oe] || 0) + 1;
    }

    const sumEntries = sortEntriesDesc(sumFreq);
    const spanEntries = sortEntriesDesc(spanFreq);
    const zoneEntries = sortEntriesDesc(zoneFreq);
    const oeEntries = sortEntriesDesc(oeFreq);

    let drawNoLatest = '';
    if (drawNos && drawNos.length) {
      let best = '';
      let bestN = -1;
      for (let i = 0; i < drawNos.length; i++) {
        const s = String(drawNos[i] || '').trim();
        const n = parseInt(s, 10);
        if (!isNaN(n) && n > bestN) {
          bestN = n;
          best = s;
        }
      }
      drawNoLatest = best || String(drawNos[drawNos.length - 1] || '').trim();
    }

    return {
      n: redsArr.length,
      hit,
      drawNoLatest,
      sumEntries,
      spanEntries,
      zoneEntries,
      oeEntries
    };
  }

  function readStatsFilter() {
    const minSum = parseIntOrNull(elStatsMinSum.value);
    const maxSum = parseIntOrNull(elStatsMaxSum.value);
    const minSpan = parseIntOrNull(elStatsMinSpan.value);
    const maxSpan = parseIntOrNull(elStatsMaxSpan.value);
    const zone = parseRatio3(elStatsZone.value);
    const oe = parseRatio2(elStatsOE.value);

    let tip = '';
    if (elStatsZone.value && zone == null) tip = '区间比格式应为 a:b:c 且和为6';
    if (!tip && elStatsOE.value && oe == null) tip = '奇偶比格式应为 a:b 且和为6';
    elStatsTip.innerText = tip;

    return {
      minSum,
      maxSum,
      minSpan,
      maxSpan,
      zone,
      oe
    };
  }

  function renderStats(filter) {
    if (!lastTrend) {
      elStatsMeta.innerText = '请先加载趋势数据';
      elStatsResult.innerHTML = '<div class="status">暂无数据</div>';
      return;
    }
    const f = filter || readStatsFilter();
    const s = computeStatsFromTrend(lastTrend, f);
    elStatsMeta.innerText = `统计范围：最近 ${lastTrend.latestN || s.n} 期（命中 ${s.hit}/${s.n}）`;

    let html = '';
    html += renderFreqTable('和值（Top 15）', s.sumEntries, 15, 'sum');
    html += renderFreqTable('跨度（Top 15）', s.spanEntries, 15, 'span');
    html += renderFreqTable('区间比（Top 15）', s.zoneEntries, 15, 'zone');
    html += renderFreqTable('奇偶比（Top 15）', s.oeEntries, 15, 'oe');
    elStatsResult.innerHTML = html || '<div class="status">暂无数据</div>';
  }

  async function syncMissing() {
    elSyncBtn.disabled = true;
    elSyncStatus.innerText = '同步中...';
    try {
      const res = await fetch(api('/api/sync/missing?maxPages=120&stopAfterNoInsertPages=3'), { method: 'POST' });
      const data = await res.json();
      elSyncStatus.innerText = `同步完成：scanned=${data.scannedPages}, inserted=${data.inserted}, errors=${(data.errors||[]).length}`;
      await loadTrend();
    } finally {
      elSyncBtn.disabled = false;
    }
  }

  async function copyFirstPick() {
    const picks = (lastPredict && lastPredict.picks) ? lastPredict.picks : [];
    if (!picks.length) {
      elPredictStatus.innerText = '请先生成预测';
      return;
    }
    const p = picks[0];
    const reds = (p.red || []).slice().sort((a,b)=>a-b).map(pad2).join(' ');
    const text = `${reds} + ${pad2(p.blue)}`;
    try {
      await navigator.clipboard.writeText(text);
      elPredictStatus.innerText = '已复制';
      setTimeout(() => { elPredictStatus.innerText = ''; }, 1200);
    } catch (e) {
      elPredictStatus.innerText = text;
    }
  }

  elSyncBtn.addEventListener('click', syncMissing);
  elRefreshBtn.addEventListener('click', loadTrend);
  elLatestN.addEventListener('change', loadTrend);
  elPredictOpenBtn.addEventListener('click', () => {
    openPredict();
  });

  elPredLibOpenBtn.addEventListener('click', async () => {
    openPredLib();
    predLibPage = 0;
    await loadPredLib(0);
  });

  elStatsOpenBtn.addEventListener('click', () => {
    openStats();
    renderStats();
  });

  elStatsApply.addEventListener('click', () => {
    renderStats();
  });

  elStatsResult.addEventListener('click', (e) => {
    const tr = e && e.target ? e.target.closest('tr') : null;
    if (!tr) return;
    const ft = tr.getAttribute('data-ft');
    const fv = tr.getAttribute('data-fv');
    if (!ft) return;
    applyStatsQuickFilter(ft, fv);
  });

  elStatsReset.addEventListener('click', () => {
    elStatsMinSum.value = '';
    elStatsMaxSum.value = '';
    elStatsMinSpan.value = '';
    elStatsMaxSpan.value = '';
    elStatsZone.value = '';
    elStatsOE.value = '';
    elStatsTip.innerText = '';
    renderStats({ minSum:null, maxSum:null, minSpan:null, maxSpan:null, zone:null, oe:null });
  });

  elPredLibClose.addEventListener('click', closePredLib);
  elPredLibOk.addEventListener('click', closePredLib);
  elPredLibQuery.addEventListener('click', async () => {
    predLibPage = 0;
    await loadPredLib(0);
  });
  elPredLibPrev.addEventListener('click', async () => {
    if (predLibPage <= 0) return;
    await loadPredLib(-1);
  });
  elPredLibNext.addEventListener('click', async () => {
    await loadPredLib(1);
  });

  elPredictBtn.addEventListener('click', predict);
  elPredictCopyBtn.addEventListener('click', copyFirstPick);

  elPredictClose.addEventListener('click', closePredict);
  elPredictOk.addEventListener('click', closePredict);
  elPredictAgain.addEventListener('click', () => {
    elPickCount.value = '1';
    predict();
  });
  elPredictMask.addEventListener('click', (e) => {
    if (e.target && e.target.id === 'predictMask') closePredict();
  });

  elStatsClose.addEventListener('click', closeStats);
  elStatsOk.addEventListener('click', closeStats);
  elStatsMask.addEventListener('click', (e) => {
    if (e.target && e.target.id === 'statsMask') closeStats();
  });

  window.addEventListener('resize', () => {
    fitTrendTable();
    syncTopScroller();
  });

  checkHealth();
  loadTrend();
</script>
</body>
</html>
